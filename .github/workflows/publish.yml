# This workflow will run tests using node and then publish a package to GitHub Packages when a release is created
# For more information see: https://help.github.com/actions/language-and-framework-guides/publishing-nodejs-packages

name: Publish package

on:
  push:
    tags:
      - 'v*'
  pull_request:
      types: [ opened, synchronize, reopened, ready_for_review ]
      branches:
      - master

jobs:
  release:
    name: Build on node ${{ matrix.node_version }} and ${{ matrix.os }}
    if: ${{ github.event_name == 'push' || github.event.pull_request.draft == false }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        node_version: [ '12.11.0', '12.17.0', '12.19.0' ]
        os: [ubuntu-latest, macOS-latest]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node_version }}
      - name: Install Dependencies
        run: |
          npm install --build-from-source
          npm run build
          npx node-pre-gyp package 
      # - name: Publish to npm
      # - run: |
      #     echo "//registry.npmjs.org/:_authToken=${{ secrets.npm_token }}" > ~/.npmrc
      #     git config --global user.name 'WenheLI'
      #     git config --global user.email 'lwh.eric@alibaba-inc.com'
      #     npm run release
      - name: boa binary artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dist-without-markdown
          path: |
            build
            .miniconda/lib
            !.miniconda/lib/**/*.a
